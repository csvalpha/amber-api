require 'rails_helper'

RSpec.describe CsvHelper, type: :helper do
  include described_class

  let(:test_file_path) { Rails.root.join('spec', 'support', 'files', 'user_import.csv') }
  let(:test_file) { File.open(test_file_path) }

  # rubocop:disable Layout/LineLength
  let(:base64_data) do
    'data:text/csv;base64,Zmlyc3RfbmFtZSxsYXN0X25hbWVfcHJlZml4LGxhc3RfbmFtZSxlbWFpbCxiaXJ0aGRheSxhZGRyZXNzLHBvc3Rjb2RlLGNpdHkscGhvbmVfbnVtYmVyLGZvb2RfcHJlZmVyZW5jZXMsdmVnZXRhcmlhbixzdHVkeSxwaWN0dXJlX3B1YmxpY2F0aW9uX3ByZWZlcmVuY2UsZW1lcmdlbmN5X2NvbnRhY3QsZW1lcmdlbmN5X251bWJlcixpZmVzX2RhdGFfc2hhcmluZ19wcmVmZXJlbmNlLGluZm9faW5fYWxtYW5hayxhbG1hbmFrX3N1YnNjcmlwdGlvbl9wcmVmZXJlbmNlLGRpZ3R1c19zdWJzY3JpcHRpb25fcHJlZmVyZW5jZSxsb2dpbl9lbmFibGVkCkFydGjDunIsZGUsS29uaW5nLUFyZW5kcyxzdGlqbkBleGFtcGxlLmNvbSwxOTcwLTItMixIZW5nZWxvc2VzdHJhYXQgMSw3NTE0TkIsRW5zY2hlZGUsICszMSgwKTYxMjM0NTY3OCwiTm90ZW4sIGxhY3Rvc2UiLHRydWUsVGVjaG5pc2NoZSBOYXR1dXJrdW5kZSxhbHdheXNfcHVibGlzaCxNLiBkZSBSdWl0ZXIsMDYyMjg2NTI1NSx0cnVlLGZhbHNlLG5vX3N1YnNjcmlwdGlvbixub19zdWJzY3JpcHRpb24sZmFsc2UKVMOrc3Rlw6csdsOzbixCw7xuZGVuc3TDoHXDnyxrb2VuQGV4YW1wbGUuY29tLDE5NzAtMi0yMCxIZW5nZWxvc2VzdHJhYXQgMyw3NTAwQUEsRW5zY2hlZGUsICszMSgwKTYxMjM0NTY3OCwsZmFsc2UsVGVjaG5pc2NoZSBLdW5kaWdoZWlkLGFsd2F5c19wdWJsaXNoLE0uIGRlIFJ1aXRlciwwNjk4NzY1NDMyLGZhbHNlLHRydWUsbm9fc3Vic2NyaXB0aW9uLG5vX3N1YnNjcmlwdGlvbixmYWxzZQpIYW5zIERhdmlkLCd0LEhvZ2UscGxla2tpZUBleGFtcGxlLmNvbSwxOTcwLTItMjAsUGxla2tpZSAzLDc1MDBBQSxOdW5zcGVldCwwNjEyMzQ1Njc4LCxmYWxzZSxUZWNobmlzY2hlIEt1bmRpZ2hlaWQsYWx3YXlzX3B1Ymxpc2gsTS4gZGUgUnVpdGVyLDA2OTg3NjU0MzIsZmFsc2UsdHJ1ZSxub19zdWJzY3JpcHRpb24sbm9fc3Vic2NyaXB0aW9uLGZhbHNlCg=='
  end

  describe '#decode_upload_file' do
    it { expect(File.read(decode_upload_file(base64_data))).to eq File.read(test_file) }
  end

  describe '#split_base_url' do
    it { expect(split_base_url(base64_data)[:data]).to eq Base64.encode64(File.read(test_file_path)).delete("\n") }
  end

  context 'with broken base64 strings' do
    describe '#decode_upload_file' do
      let(:broken_base64_data) do
        'data:text/csv;base64,Zmlyc3RfbmFtZSxsYXN0X25hbWVfcHJlZml4LGxhc3RfbmFtZSxlbWFpbCxiaXJ0aGRheSxhZGRyZXNzLHBvc3Rjb2RlLGNpdHkscGhvbmVfbnVtYmVyLGFsbGVyZ2llcyx2ZWdldGFyaWFuLHN0dWR5LHBpY3R1cmVfcHVibGljYXRðŸ˜ˆpb25fcHJlZmVyZW5jZSxlbWVyZ2VuY3lfY29udGFjdCxlbWVyZ2VuY3lfbnVtYmVyLGlmZXNfZGF0YV9zaGFyaW5nX3ByZWZlcmVuY2UsaW5mb19pbl9hbG1hbmFrLGFsbWFuYWtfc3Vic2NyaXB0aW9uX3ByZWZlcmVuY2UsZGlndHVzX3N1YnNjcmlwdGlvbl9wcmVmZXJlbmNlLGxvZ2luX2VuYWJsZWQKQXJ0aMO6cixkZSxLb25pbmctQXJlbmRzLHN0aWpuQGV4YW1wbGUuY29tLDE5NzAtMi0yLEhlbmdlbG9zZXN0cmFhdCAxLDc1MTROQixFbnNjaGVkZSwgKzMxKDApNjEyMzQ1Njc4LCJOb3RlbiwgbGFjdG9zZSIsdHJ1ZSxUZWNobmlzY2hlIE5hdHV1cmt1bmRlLGFsd2F5c19wdWJsaXNoLE0uIGRlIFJ1aXRlciwwNjIyODY1MjU1LHRydWUsZmFsc2Usbm9fc3Vic2NyaXB0aW9uLG5vX3N1YnNjcmlwdGlvbixmYWxzZQpUw6tzdGXDpyx2w7NuLELDvG5kZW5zdMOgdcOfLGtvZW5AZXhhbXBsZS5jb20sMTk3MC0yLTIwLEhlbmdlbG9zZXN0cmFhdCAzLDc1MDBBQSxFbnNjaGVkZSwgKzMxKDApNjEyMzQ1Njc4LCxmYWxzZSxUZWNobmlzY2hlIEt1bmRpZ2hlaWQsYWx3YXlzX3B1Ymxpc2gsTS4gZGUgUnVpdGVyLDA2OTg3NjU0MzIsZmFsc2UsdHJ1ZSxub19zdWJzY3JpcHRpb24sbm9fc3Vic2NyaXB0aW9uLGZhbHNlCkhhbnMgRGF2aWQsJ3QsSG9nZSxwbGVra2llQGV4YW1wbGUuY29tLDE5NzAtMi0yMCxQbGVra2llIDMsNzUwMEFBLE51bnNwZWV0LDA2MTIzNDU2NzgsLGZhbHNlLFRlY2huaXNjaGUgS3VuZGlnaGVpZCxhbHdheXNfcHVibGlzaCxNLiBkZSBSdWl0ZXIsMDY5ODc2NTQzMixmYWxzZSx0cnVlLG5vX3N1YnNjcmlwdGlvbixub19zdWJzY3JpcHRpb24sZmFsc2UK'
      end

      it { expect(decode_upload_file(broken_base64_data)).to be_instance_of Tempfile }
    end

    describe '#split_base_url' do
      let(:extremely_broken_base64_data) do
        'dataev;base6mlyc3RfbmFtZSxsYXN0X25hbWVfcHJlZml4LGxhc3RfbmFtZSxlbWFpbCxiaXJ0aGRheSxhZGRyZXNzLHBvc3Rjb2RlLGNpdHkscGhvbmVfbnVtYmVyLGFsbGVyZ2llcyx2ZWdldGFyaWFuLHN0dWR5LHBpY3R1cmVfcHVibGljYXRpb25fcHJlZmVyZW5jZSxpYmFuLGliYW5faG9sZGVyPANICLGVtZXJnZW5jeV9jb250YWN0LGVtZXJnZW5jeV9udW1iZXIsaWZlc19kYXRhX3NoYXJpbmdfcHJlZmVyZW5jZSxpbmZvX2luX2FsbWFuYWssYWxtYW5ha19zdWJzY3JpcHRpb25fcHJlZmVyZW5jZSxkaWd0dXNfc3Vic2NyaXB0aW9uX3ByZWZlcmVuY2UsZW5hYmxlZApBcnRow7pyLGRlLEtvbmluZy1BcmVuZHMsc3Rpam5AZXhhbXBsZS5jb20sMTk3MC0yLTIsSGVuZ2Vsb3Nlc3RyYWF0IDEsNzUxNE5CLEVuc2NoZWRlLCArMzEoMCk2MTIzNDU2NzgsIk5vdGVuLCBsYWN0b3NlIix0cnVlLFRlYwhat?'
      end

      it { expect(split_base_url(extremely_broken_base64_data)).to be_nil }
    end

    # rubocop:enable Layout/LineLength
  end
end
